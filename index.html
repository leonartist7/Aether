<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmonic Void: Architect</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #050508; overflow: hidden;
            font-family: 'Rajdhani', sans-serif;
            color: white; user-select: none; touch-action: none;
        }

        /* --- VIEW MANAGER --- */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #050508; transition: opacity 0.5s; z-index: 100;
            padding: 20px; text-align: center;
        }
        .view.hidden { opacity: 0; pointer-events: none; z-index: -1; }

        /* --- PAGE 1 & 2 STYLES --- */
        h1 { font-size: 30px; letter-spacing: 5px; margin-bottom: 40px; text-transform: uppercase; }
        h2 { font-size: 18px; color: #888; margin-bottom: 20px; font-weight: normal; }
        
        .card-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        .card {
            width: 140px; height: 160px; border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px; background: rgba(255,255,255,0.05);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.2s;
        }
        .card:hover, .card.selected { background: white; color: black; transform: scale(1.05); border-color: white; }
        .card-icon { font-size: 40px; margin-bottom: 15px; }
        .card-title { font-weight: bold; font-size: 16px; }
        .card-desc { font-size: 10px; margin-top: 5px; opacity: 0.7; }

        .option-list { text-align: left; width: 100%; max-width: 300px; margin-bottom: 30px; }
        .option-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .toggle {
            width: 40px; height: 20px; background: #333; border-radius: 10px; position: relative; cursor: pointer;
        }
        .toggle::after {
            content:''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px;
            background: #888; border-radius: 50%; transition: 0.2s;
        }
        .toggle.on { background: #4caf50; }
        .toggle.on::after { left: 22px; background: white; }

        .next-btn {
            margin-top: 40px; padding: 15px 50px; font-size: 18px;
            border: 2px solid white; background: transparent; color: white;
            text-transform: uppercase; letter-spacing: 3px; cursor: pointer;
            transition: 0.2s;
        }
        .next-btn:hover { background: white; color: black; }

        /* --- PAGE 3 (APP) STYLES --- */
        #app-view { z-index: 1; } /* Base layer */
        #canvas-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #svg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center;}

        /* MANDALA & SEQUENCER */
        #mandala { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 60vh; height: 60vh; max-width: 500px; max-height: 500px; }
        #sequencer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40%; height: 40%; border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 5; }
        
        #seq-sun {
            width: 70px; height: 70px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(2px);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: rgba(255,255,255,0.7); font-weight: bold; font-size: 11px;
            cursor: pointer; z-index: 30; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 20px rgba(255,255,255,0.1); transition: transform 0.1s;
        }
        #seq-sun:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        
        .planet {
            position: absolute; width: 28px; height: 28px;
            background: rgba(30,30,40,0.6); border: 1px solid rgba(255,255,255,0.3); border-radius: 50%;
            cursor: pointer; transition: 0.1s; z-index: 25; transform: translate(-50%, -50%);
        }
        .planet.hovered { border-color: #fff; box-shadow: 0 0 20px #fff; transform: translate(-50%, -50%) scale(1.5); }
        .planet.active { background: rgba(255,255,255,0.9); border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.5); transform: translate(-50%, -50%) scale(1.2); }
        .planet.trigger { background: #ff0055; box-shadow: 0 0 40px #ff0055; transform: translate(-50%, -50%) scale(1.6); }

        /* CHORDS */
        .chord-orb {
            position: absolute; width: 75px; height: 75px; border-radius: 50%;
            background: rgba(30,30,40,0.4); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(4px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: background 0.1s, box-shadow 0.1s; z-index: 20; transform: translate(-50%, -50%);
        }
        .chord-orb.active { background: var(--glow); color: white; border-color: white; box-shadow: 0 0 60px var(--glow); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .roman { font-size: 20px; font-weight: 700; pointer-events: none; opacity: 0.9; }
        
        /* PIVOTS */
        .pivot-group { position: absolute; pointer-events: none; display: flex; gap: 8px; justify-content: center; transform: translate(-50%, -50%); z-index: 15; }
        .pivot-btn {
            pointer-events: auto; width: 35px; height: 35px; border-radius: 50%; 
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.3);
            color: #aaa; font-size: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s;
        }
        .pivot-btn:hover { background: white; color: black; transform: scale(1.1); }

        /* CONTROLS */
        #controls-deck {
            position: absolute; bottom: 0; width: 100%; height: 180px;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, transparent 100%); 
            pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 20px; align-items: center;
        }
        .deck-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; pointer-events: auto; }
        
        .pad-btn {
            width: 90px; height: 65px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px;
            background: rgba(20,20,30,0.3); backdrop-filter: blur(5px); color: rgba(255,255,255,0.7);
            display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; cursor: pointer; letter-spacing: 2px; transition: 0.2s; user-select: none;
            position: relative; overflow: hidden; 
        }
        .pad-btn.active { background: rgba(255,255,255,0.9); color: black; box-shadow: 0 0 30px rgba(255,255,255,0.3); border-color: white; transform: scale(0.95); }
        .pad-btn.locked { background: rgba(255, 0, 85, 0.8); color: white; border-color: #ff0055; box-shadow: 0 0 30px #ff0055; }
        .locked-label { position: absolute; bottom: -20px; font-size: 9px; color: #ff0055; font-weight: bold; opacity: 0; transition: opacity 0.2s;}
        .pad-btn.locked .locked-label { opacity: 1; }

        .inst-btn {
            width: 45px; height: 45px; border: 1px solid rgba(255,255,255,0.3); background: rgba(20,20,30,0.3); cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: 0.2s; border-radius: 6px;
        }
        .inst-btn.selected { border-color: #ffcc00; box-shadow: 0 0 15px rgba(255, 204, 0, 0.3); background: rgba(255, 204, 0, 0.1); }
        .icon { width: 18px; height: 18px; background: rgba(255,255,255,0.5); }
        .inst-btn.selected .icon { opacity: 1; background: #ffcc00; }
        .i-tri { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); } .i-sq { } .i-cir { border-radius: 50%; }

        /* VOICING */
        #voicing-control {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%); height: 200px; width: 40px; pointer-events: auto;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 6px; height: 150px; padding: 0 5px; background: rgba(255,255,255,0.1); border-radius: 4px;
        }
        .v-label { font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; writing-mode: vertical-rl; transform: rotate(180deg); }

        /* SETTINGS DRAWER */
        #settings-toggle { position: absolute; bottom: 30px; right: 30px; color: rgba(255,255,255,0.5); font-size: 28px; cursor: pointer; pointer-events: auto; z-index: 100; transition: 0.3s; }
        #settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50%;
            background: rgba(10,10,15,0.95); z-index: 90; transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border-top: 1px solid #444; padding: 30px; display: flex; flex-direction: column; gap: 15px; pointer-events: auto;
        }
        #settings-panel.open { transform: translateY(0); }
        .setting-row { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        select, input[type=range]:not([orient=vertical]) { background: #222; color: white; border: 1px solid #444; padding: 10px; border-radius: 4px; outline: none; font-family: inherit; }
        .drag-line { stroke: white; stroke-width: 2px; stroke-linecap: round; opacity: 0.7; filter: drop-shadow(0 0 5px white); }
    </style>
</head>
<body>

    <!-- PAGE 1: DEVICE SELECT -->
    <div id="view-device" class="view">
        <h1>Harmonic Void</h1>
        <h2>Select Your Device</h2>
        <div class="card-container">
            <div class="card" onclick="Manager.selectDevice('lite')">
                <div class="card-icon">ðŸ“±</div>
                <div class="card-title">Mobile</div>
                <div class="card-desc">Optimized Performance</div>
            </div>
            <div class="card" onclick="Manager.selectDevice('pro')">
                <div class="card-icon">ðŸ’»</div>
                <div class="card-title">Desktop</div>
                <div class="card-desc">High Quality Visuals</div>
            </div>
        </div>
    </div>

    <!-- PAGE 2: CUSTOM SETUP -->
    <div id="view-setup" class="view hidden">
        <h1>Features</h1>
        <div class="option-list">
            <div class="option-row">
                <span>Drag Cables</span>
                <div class="toggle on" id="tog-cables" onclick="this.classList.toggle('on')"></div>
            </div>
            <div class="option-row">
                <span>Ambient Motion</span>
                <div class="toggle" id="tog-motion" onclick="this.classList.toggle('on')"></div>
            </div>
            <div class="option-row">
                <span>High Res Canvas</span>
                <div class="toggle on" id="tog-hires" onclick="this.classList.toggle('on')"></div>
            </div>
        </div>
        <button class="next-btn" onclick="Manager.launch()">Ignite</button>
    </div>

    <!-- PAGE 3: THE APP -->
    <div id="app-view" class="view hidden">
        <div id="canvas-layer"><canvas id="main-canvas"></canvas></div>
        <svg id="svg-layer"><line id="drag-cable" x1="0" y1="0" x2="0" y2="0" class="drag-line" style="display:none;"></line></svg>

        <div id="ui-layer">
            <div id="mandala">
                <div id="sequencer">
                    <div id="radar-container"></div>
                    <div id="seq-sun">KICK</div>
                </div>
            </div>

            <div id="voicing-control">
                <div class="v-label">High</div>
                <input type="range" orient="vertical" id="octave-slider" min="-2" max="2" step="1" value="0">
                <div class="v-label">Low</div>
            </div>

            <div id="controls-deck">
                <div class="deck-row">
                    <div class="pad-btn" id="btn-arp">
                        ARP
                        <div class="locked-label">LOCKED</div>
                    </div>
                    <div class="pad-btn" id="btn-pulse">PULSE</div>
                </div>
                <div class="deck-row">
                    <div class="inst-btn selected" data-type="pad"><div class="icon i-cir"></div></div>
                    <div class="inst-btn" data-type="piano"><div class="icon i-tri"></div></div>
                    <div class="inst-btn" data-type="lead"><div class="icon i-sq"></div></div>
                </div>
            </div>

            <div id="settings-toggle">âš™</div>
            <div id="settings-panel">
                <div class="setting-row"><label>Key</label><select id="root-select"></select></div>
                <div class="setting-row"><label>Scale</label><select id="scale-select"></select></div>
                <div class="setting-row"><label>Master Tuning</label><input type="range" id="tuning-range" min="432" max="448" value="440"><div id="tuning-val">440 Hz</div></div>
                <div class="setting-row"><label>Mod X</label><select id="mod-x-select"><option value="reverb">Reverb</option><option value="filter">Filter</option></select></div>
                <div class="setting-row"><label>Mod Y</label><select id="mod-y-select"><option value="filter">Filter</option><option value="reverb">Reverb</option></select></div>
            </div>
        </div>
    </div>

    <script>
        /** --- CONFIG MANAGER --- */
        const Config = {
            device: 'lite',
            dragCables: true,
            ambientMotion: false,
            highRes: true
        };

        const Manager = {
            selectDevice(type) {
                Config.device = type;
                // Auto-configure defaults
                if (type === 'lite') {
                    document.getElementById('tog-cables').classList.remove('on');
                    document.getElementById('tog-motion').classList.remove('on');
                    document.getElementById('tog-hires').classList.remove('on');
                } else {
                    document.getElementById('tog-cables').classList.add('on');
                    document.getElementById('tog-motion').classList.add('on');
                    document.getElementById('tog-hires').classList.add('on');
                }
                document.getElementById('view-device').classList.add('hidden');
                document.getElementById('view-setup').classList.remove('hidden');
            },
            launch() {
                // Read Toggles
                Config.dragCables = document.getElementById('tog-cables').classList.contains('on');
                Config.ambientMotion = document.getElementById('tog-motion').classList.contains('on');
                Config.highRes = document.getElementById('tog-hires').classList.contains('on');

                document.getElementById('view-setup').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                
                // Initialize Systems
                Audio.init();
                if(Audio.ctx) Audio.ctx.resume();
                Vis.init();
                Logic.init();
            }
        };

        /** THEORY */
        const Theory = {
            notes: ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'],
            scales: { major: [0,2,4,5,7,9,11], minor: [0,2,3,5,7,8,10], dorian: [0,2,3,5,7,9,10], lydian: [0,2,4,6,7,9,11] },
            colors: ['rgb(255, 60, 60)', 'rgb(255, 160, 60)', 'rgb(255, 220, 60)', 'rgb(80, 255, 100)', 'rgb(60, 200, 255)', 'rgb(100, 120, 255)', 'rgb(200, 80, 255)'],
            getFreq(note, octave, tuning=440) {
                const idx = this.notes.indexOf(note);
                const semitones = idx - 9 + (octave - 4) * 12;
                return tuning * Math.pow(2, semitones / 12);
            },
            getScale(root, scaleName) {
                const rootIdx = this.notes.indexOf(root);
                return this.scales[scaleName].map(interval => this.notes[(rootIdx + interval) % 12]);
            },
            getChord(scaleNotes, degree, rootOctave=3, tuning=440) {
                const indices = [degree, (degree+2)%7, (degree+4)%7, (degree+6)%7];
                const notes = indices.map((idx, pos) => {
                    let n = scaleNotes[idx];
                    let o = rootOctave;
                    if(pos === 0) { if(this.notes.indexOf(n) >= 7) o = 2; else o = 3; } 
                    else { o = 4; if(idx < degree) o++; }
                    return { note: n, freq: this.getFreq(n, o, tuning), octave: o }; 
                });
                return { notes, name: notes[0].note, degree };
            }
        };

        /** AUDIO */
        const Audio = {
            ctx: null, master: null, inst: 'pad', activeVoices: new Map(),
            init() {
                try {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                    this.master = this.ctx.createGain(); this.master.gain.value = 0.4;
                    this.verb = this.ctx.createConvolver(); 
                    // Simple Reverb
                    const len = this.ctx.sampleRate * 2.5; const buf = this.ctx.createBuffer(2, len, this.ctx.sampleRate);
                    for(let i=0; i<len; i++) { buf.getChannelData(0)[i] = (Math.random()*2-1)*Math.pow(1-i/len,2); buf.getChannelData(1)[i] = (Math.random()*2-1)*Math.pow(1-i/len,2); }
                    this.verb.buffer = buf;
                    this.master.connect(this.ctx.destination);
                    this.master.connect(this.verb); this.verb.connect(this.ctx.destination);
                    return true;
                } catch(e) { return false; }
            },
            playChord(chord, id, modX=0, modY=0) {
                if(!this.ctx) return;
                this.stopChord(id);
                const voices = [];
                const octaveShift = APP.octave * 12; 
                const freqMult = Math.pow(2, octaveShift/12);
                chord.notes.forEach((n, i) => { 
                    const v = this.createVoice(n.freq * freqMult, this.ctx.currentTime + i*0.01);
                    voices.push(v); 
                });
                this.activeVoices.set(id, voices);
                this.modulateChord(id, modX, modY);
            },
            stopChord(id) {
                if(!this.ctx) return;
                if(this.activeVoices.has(id)) {
                    this.activeVoices.get(id).forEach(v => {
                        v.gain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.2);
                        v.osc.stop(this.ctx.currentTime + 0.3);
                    });
                    this.activeVoices.delete(id);
                }
            },
            createVoice(freq, startTime) {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); const filter = this.ctx.createBiquadFilter();
                const wet = this.ctx.createGain(); wet.gain.value = 0;
                if(this.inst==='pad') { osc.type='triangle'; filter.frequency.value=800; gain.gain.setValueAtTime(0,startTime); gain.gain.linearRampToValueAtTime(0.15,startTime+0.3); }
                else if(this.inst==='piano') { osc.type='triangle'; filter.frequency.value=3000; gain.gain.setValueAtTime(0,startTime); gain.gain.exponentialRampToValueAtTime(0.001,startTime+2); }
                else { osc.type='sawtooth'; filter.frequency.value=2000; gain.gain.setValueAtTime(0,startTime); gain.gain.setTargetAtTime(0.08,startTime+0.1,0.5); }
                osc.frequency.value = freq; osc.connect(filter); filter.connect(gain); gain.connect(this.master);
                filter.connect(wet); wet.connect(this.verb); osc.start(startTime);
                return { osc, gain, filter, wet, baseFreq: filter.frequency.value };
            },
            modulateChord(id, x, y) {
                if(!this.ctx || !this.activeVoices.has(id)) return;
                const voices = this.activeVoices.get(id);
                // Map based on radial (y) and tangential (x)
                let cut = 1; let wet = 0;
                
                if(APP.modY === 'filter') cut = Math.max(0.2, Math.min(4.0, 1 + (y * 0.02))); // Outwards = Bright
                if(APP.modX === 'reverb') wet = Math.max(0, Math.min(1, Math.abs(x) * 0.005));

                voices.forEach(v => {
                    if(v.filter) v.filter.frequency.setTargetAtTime(v.baseFreq * cut, this.ctx.currentTime, 0.1);
                    if(v.wet) v.wet.gain.setTargetAtTime(wet, this.ctx.currentTime, 0.1);
                });
            },
            playOneShot(freq, time, dur, modX=0, modY=0) {
                const osc = this.ctx.createOscillator(); osc.type = this.inst==='pad'?'triangle':'sawtooth'; 
                osc.frequency.value = freq;
                const g = this.ctx.createGain(); const f = this.ctx.createBiquadFilter(); f.frequency.value = 2500;
                osc.connect(f); f.connect(g); g.connect(this.master);
                g.gain.setValueAtTime(0, time); g.gain.linearRampToValueAtTime(0.2, time+0.01); g.gain.exponentialRampToValueAtTime(0.001, time+dur);
                osc.start(time); osc.stop(time+dur);
            },
            playKick() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
                osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.01, t+0.5);
                g.gain.setValueAtTime(1, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.5);
                osc.connect(g); g.connect(this.master); osc.start(t); osc.stop(t+0.5);
            }
        };

        /** VISUALS */
        const Vis = {
            canvas: null, ctx: null, clouds: [], blobs: [],
            init() {
                this.canvas = document.getElementById('main-canvas');
                this.ctx = this.canvas.getContext('2d');
                if(Config.ambientMotion) {
                    for(let i=0; i<6; i++) this.blobs.push({x:Math.random(),y:Math.random(),r:200,color:{r:10,g:10,b:20},dx:0.001,dy:0.001});
                }
                this.resize(); window.addEventListener('resize', ()=>this.resize());
                this.loop();
            },
            resize() {
                const dpr = Config.highRes ? (window.devicePixelRatio || 1) : 1;
                this.canvas.width = window.innerWidth * dpr; this.canvas.height = window.innerHeight * dpr;
                this.ctx.scale(dpr, dpr);
            },
            trigger(colorStr, isKick=false) {
                const w = window.innerWidth; const h = window.innerHeight;
                // Center
                const sun = document.getElementById('seq-sun');
                let cx=w/2; let cy=h/2;
                if(sun) { const r=sun.getBoundingClientRect(); cx=r.left+r.width/2; cy=r.top+r.height/2; }

                if(isKick) {
                    this.clouds.push({type:'kick', r:30, maxR:Math.max(w,h)*0.5, alpha:0.2, x:cx, y:cy, color:'255,255,255'});
                } else {
                    let c = '255,255,255'; 
                    if(colorStr.startsWith('rgb')) c = colorStr.match(/\d+,\s*\d+,\s*\d+/)[0];
                    // Add sustained cloud
                    this.clouds.push({type:'chord', r:10, maxR:Math.max(w,h)*1.2, alpha:0.6, x:cx, y:cy, color:c});
                }
            },
            loop() {
                requestAnimationFrame(this.loop.bind(this));
                const w = window.innerWidth; const h = window.innerHeight;
                let cx = w/2; let cy = h/2;
                const sun = document.getElementById('seq-sun');
                if(sun) { const r=sun.getBoundingClientRect(); cx=r.left+r.width/2; cy=r.top+r.height/2; }

                this.ctx.fillStyle = '#000'; this.ctx.fillRect(0,0,w,h);
                
                // Ambient
                if(Config.ambientMotion) {
                    this.ctx.globalCompositeOperation = 'screen';
                    this.blobs.forEach(b => {
                        b.x+=b.dx; b.y+=b.dy; if(b.x>1)b.x=0; if(b.y>1)b.y=0;
                        const g = this.ctx.createRadialGradient(b.x*w, b.y*h, 0, b.x*w, b.y*h, b.r);
                        g.addColorStop(0, `rgba(${b.color.r},${b.color.g},${b.color.b},0.3)`);
                        g.addColorStop(1, `rgba(0,0,0,0)`);
                        this.ctx.fillStyle=g; this.ctx.beginPath(); this.ctx.arc(b.x*w, b.y*h, b.r, 0, Math.PI*2); this.ctx.fill();
                    });
                }

                // Pulses
                this.ctx.globalCompositeOperation = 'screen';
                for(let i=this.clouds.length-1; i>=0; i--) {
                    let p = this.clouds[i];
                    p.r += p.type === 'kick' ? 4 : 2; // Slow bloom
                    p.alpha -= p.type === 'kick' ? 0.005 : 0.002;
                    
                    if(p.alpha <= 0) { this.clouds.splice(i,1); continue; }
                    
                    const g = this.ctx.createRadialGradient(cx, cy, 0, cx, cy, p.r);
                    g.addColorStop(0, `rgba(${p.color}, 0)`);
                    g.addColorStop(0.5, `rgba(${p.color}, ${p.alpha})`);
                    g.addColorStop(1, `rgba(${p.color}, 0)`);
                    this.ctx.fillStyle = g; this.ctx.beginPath(); this.ctx.arc(cx, cy, p.r, 0, Math.PI*2); this.ctx.fill();
                }
                this.ctx.globalCompositeOperation = 'source-over';
            }
        };

        /** LOGIC & UI */
        const APP = { root:'C', scale:'major', tuning:440, inst:'pad', bpm:120, octave:0, activeChords:new Set(), performanceMode:null, arpLocked:false, modX:'reverb', modY:'filter' };
        const Sequencer = { steps:Array(8).fill(false), pos:0 };

        const Logic = {
            init() {
                this.setupUI();
                this.renderMandala();
                this.renderSequencer();
                this.startClock();
            },
            setupUI() {
                // Populate Selects
                const rSel = document.getElementById('root-select'); Theory.notes.forEach(n => rSel.add(new Option(n, n)));
                rSel.onchange = e => { APP.root = e.target.value; this.renderMandala(); };
                const sSel = document.getElementById('scale-select'); Object.keys(Theory.scales).forEach(k => sSel.add(new Option(k, k)));
                sSel.onchange = e => { APP.scale = e.target.value; this.renderMandala(); };
                document.getElementById('tuning-range').oninput = e => { APP.tuning = parseInt(e.target.value); document.getElementById('tuning-val').innerText = APP.tuning + ' Hz'; this.renderMandala(); };
                document.getElementById('settings-toggle').onclick = () => document.getElementById('settings-panel').classList.toggle('open');
                document.getElementById('octave-slider').oninput = e => { APP.octave = parseInt(e.target.value); this.renderMandala(); };
                document.querySelectorAll('.inst-btn').forEach(btn => { btn.onclick = () => { document.querySelectorAll('.inst-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); Audio.inst = btn.dataset.type; }; });
                document.getElementById('mod-x-select').onchange = e => APP.modX = e.target.value;
                document.getElementById('mod-y-select').onchange = e => APP.modY = e.target.value;

                // Pad Handlers
                const handlePad = (id, mode) => {
                    const btn = document.getElementById(id); let startY=0; let touched=false;
                    const start = (e) => {
                        if(e.type==='mousedown'&&touched)return; if(e.type==='touchstart')touched=true;
                        e.preventDefault(); startY = e.touches?e.touches[0].clientY:e.clientY;
                        if(mode==='arp' && APP.arpLocked) {
                            APP.arpLocked=false; btn.classList.remove('locked'); APP.performanceMode=null;
                            APP.activeChords.forEach(it => Audio.playChord(it.chord, it.id, it.modX, it.modY));
                        } else {
                            APP.performanceMode = mode; btn.classList.add('active');
                            APP.activeChords.forEach(it => Audio.stopChord(it.id));
                        }
                    };
                    const move = (e) => { if(mode==='arp' && !APP.arpLocked && APP.performanceMode==='arp') { const y = e.touches?e.touches[0].clientY:e.clientY; if(y-startY>50){APP.arpLocked=true; btn.classList.add('locked');} } };
                    const end = (e) => {
                        if(e.type==='mouseup'&&touched)return; e.preventDefault();
                        if(mode==='arp' && APP.arpLocked) return;
                        APP.performanceMode = null; btn.classList.remove('active');
                        APP.activeChords.forEach(it => Audio.playChord(it.chord, it.id, it.modX, it.modY));
                    };
                    btn.addEventListener('mousedown', start); btn.addEventListener('touchstart', start);
                    btn.addEventListener('mousemove', move); btn.addEventListener('touchmove', move);
                    btn.addEventListener('mouseup', end); btn.addEventListener('touchend', end); btn.addEventListener('mouseleave', end);
                };
                handlePad('btn-arp', 'arp'); handlePad('btn-pulse', 'pulse');
            },
            renderMandala() {
                const con = document.getElementById('mandala');
                con.querySelectorAll('.chord-orb, .pivot-group').forEach(e => e.remove());
                const notes = Theory.getScale(APP.root, APP.scale);
                const romans = ['I','II','III','IV','V','VI','VII'];
                
                for(let i=0; i<7; i++) {
                    const chord = Theory.getChord(notes, i, 3, APP.tuning);
                    const a = (i/7)*Math.PI*2 - Math.PI/2;
                    const x = 50 + Math.cos(a)*40; const y = 50 + Math.sin(a)*40;
                    const el = document.createElement('div'); el.className='chord-orb';
                    el.style.left=x+'%'; el.style.top=y+'%';
                    el.style.setProperty('--glow', Theory.colors[i]);
                    el.innerHTML = `<div class="roman">${romans[i]}</div><div class="note-name">${chord.name}</div>`;
                    
                    let startY=0; let startX=0; let active=false; let startDist=0;
                    const id = `chord-${i}`;
                    
                    const start = (e) => {
                        e.preventDefault(); 
                        active=true;
                        startY = e.touches?e.touches[0].clientY:e.clientY;
                        startX = e.touches?e.touches[0].clientX:e.clientX;
                        const cx = window.innerWidth/2; const cy = window.innerHeight/2;
                        startDist = Math.hypot(startX-cx, startY-cy);
                        
                        el.classList.add('active');
                        const item = {id, chord, index:i, modX:0, modY:0, startDist};
                        APP.activeChords.add(item);
                        Vis.trigger(Theory.colors[i]);
                        this.showPivots(x, y, chord.name);
                        
                        if(!APP.performanceMode && !APP.arpLocked) Audio.playChord(chord, id);
                    };
                    const move = (e) => {
                        if(!active) return;
                        const cy = e.touches?e.touches[0].clientY:e.clientY;
                        const cx = e.touches?e.touches[0].clientX:e.clientX;
                        const dx = cx - startX;
                        // Radial Drag
                        const scrCx = window.innerWidth/2; const scrCy = window.innerHeight/2;
                        const currDist = Math.hypot(cx-scrCx, cy-scrCy);
                        const dy = currDist - startDist; // Out = positive
                        
                        el.style.transform = `translate(-50%, -50%) translate(${dx*0.2}px, ${dy*0.2}px) scale(1.1)`;
                        Audio.modulateChord(id, dx, dy);
                        APP.activeChords.forEach(it => { if(it.id === id) { it.modX=dx; it.modY=dy; } });
                    };
                    const end = (e) => {
                        if(!active) return; active=false;
                        el.classList.remove('active'); el.style.transform = 'translate(-50%, -50%)';
                        Audio.stopChord(id);
                        APP.activeChords.forEach(it => { if(it.id === id) APP.activeChords.delete(it); });
                    };
                    
                    el.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
                    el.addEventListener('touchstart', start); window.addEventListener('touchmove', move); window.addEventListener('touchend', end);
                    con.appendChild(el);
                }
            },
            showPivots(px, py, root) {
                document.querySelectorAll('.pivot-group').forEach(e=>e.remove());
                const g = document.createElement('div'); g.className='pivot-group';
                const dx = (px-50)*1.4; const dy = (py-50)*1.4;
                g.style.left = (50+dx)+'%'; g.style.top = (50+dy)+'%';
                ['Maj','Min'].forEach(m => {
                    const b = document.createElement('div'); b.className='pivot-btn'; b.innerText=m;
                    const click = (e) => { e.stopPropagation(); APP.root=root; APP.scale=m==='Maj'?'major':'minor'; document.getElementById('root-select').value=root; document.getElementById('scale-select').value=APP.scale; this.renderMandala(); };
                    b.addEventListener('mousedown', click); b.addEventListener('touchstart', click);
                    g.appendChild(b);
                });
                document.getElementById('mandala').appendChild(g);
            },
            renderSequencer() {
                const con = document.getElementById('sequencer');
                const sun = document.getElementById('seq-sun');
                const line = document.getElementById('drag-cable');
                const planets = [];
                for(let i=0; i<8; i++) {
                    const p = document.createElement('div'); p.className = 'planet'; p.id='planet-'+i;
                    const a = (i/8)*Math.PI*2 - Math.PI/2;
                    p.style.left = (50 + Math.cos(a)*45)+'%'; p.style.top = (50 + Math.sin(a)*45)+'%';
                    const toggle = (e) => { e.stopPropagation(); Sequencer.steps[i] = !Sequencer.steps[i]; p.classList.toggle('active'); };
                    p.addEventListener('mousedown', toggle); p.addEventListener('touchstart', toggle);
                    con.appendChild(p); planets.push(p);
                }
                
                // DRAG LOGIC (Restored)
                let dragging = false;
                if(!Config.dragCables) {
                    // Tap only mode if Lite
                    const tap = (e) => { e.stopPropagation(); e.preventDefault(); Audio.playKick(); Vis.trigger('rgb(255,255,255)', true); };
                    sun.addEventListener('mousedown', tap); sun.addEventListener('touchstart', tap);
                    return;
                }

                const startDrag = (e) => { e.preventDefault(); e.stopPropagation(); dragging=true; line.style.display='block'; updateLine(e); };
                const updateLine = (e) => {
                    if(!dragging) return;
                    const cx = e.touches?e.touches[0].clientX:e.clientX; const cy = e.touches?e.touches[0].clientY:e.clientY;
                    const r = sun.getBoundingClientRect(); const sx = r.left+r.width/2; const sy = r.top+r.height/2;
                    line.setAttribute('x1', sx); line.setAttribute('y1', sy); line.setAttribute('x2', cx); line.setAttribute('y2', cy);
                    planets.forEach(p => {
                        const pr = p.getBoundingClientRect(); const dist = Math.hypot(cx - (pr.left+pr.width/2), cy - (pr.top+pr.height/2));
                        if(dist<40) p.classList.add('hovered'); else p.classList.remove('hovered');
                    });
                };
                const endDrag = (e) => {
                    if(!dragging) return; dragging=false; line.style.display='none';
                    const cx = line.getAttribute('x2'); const cy = line.getAttribute('y2');
                    // Check drop
                    planets.forEach((p, i) => {
                        p.classList.remove('hovered');
                        const pr = p.getBoundingClientRect();
                        const dist = Math.hypot(cx - (pr.left+pr.width/2), cy - (pr.top+pr.height/2));
                        if(dist<40) { Sequencer.steps[i]=true; p.classList.add('active'); }
                    });
                    // If short drag, play kick
                    const r = sun.getBoundingClientRect(); const sx = r.left+r.width/2; const sy = r.top+r.height/2;
                    if(Math.hypot(cx-sx, cy-sy) < 20) { Audio.playKick(); Vis.trigger('rgb(255,255,255)', true); }
                };
                sun.addEventListener('mousedown', startDrag); window.addEventListener('mousemove', updateLine); window.addEventListener('mouseup', endDrag);
                sun.addEventListener('touchstart', startDrag); window.addEventListener('touchmove', updateLine); window.addEventListener('touchend', endDrag);
            },
            startClock() {
                let sixteenthCounter = 0;
                const loop = () => {
                    requestAnimationFrame(loop);
                    if(!Audio.ctx) return;
                    const time = Audio.ctx.currentTime;
                    const beatDur = 60 / APP.bpm;
                    const stepDur = beatDur/2; const sixteenthDur = beatDur/4; 
                    const cycle = stepDur*8;
                    const progress = (time % cycle) / cycle;
                    const currentStep = Math.floor(progress * 8);
                    if(currentStep !== Sequencer.pos) {
                        Sequencer.pos = currentStep;
                        if(Sequencer.steps[currentStep]) {
                            Audio.playKick(); Vis.trigger('rgb(255,255,255)', true);
                            const p = document.getElementById('planet-'+currentStep);
                            if(p) { p.classList.add('trigger'); setTimeout(() => p.classList.remove('trigger'), 100); }
                        }
                        if(APP.performanceMode === 'pulse' && APP.activeChords.size > 0) {
                            const octaveShift = APP.octave * 12; const freqMult = Math.pow(2, octaveShift/12);
                            APP.activeChords.forEach(item => {
                                item.chord.notes.forEach(n => Audio.playOneShot(n.freq * freqMult, time, 0.2, item.modX, item.modY));
                                Vis.trigger(Theory.colors[item.index]);
                            });
                        }
                    }
                    const current16th = Math.floor(time / sixteenthDur);
                    if(current16th !== sixteenthCounter) {
                        sixteenthCounter = current16th;
                        if((APP.performanceMode === 'arp' || APP.arpLocked) && APP.activeChords.size > 0) {
                            const octaveShift = APP.octave * 12; const freqMult = Math.pow(2, octaveShift/12);
                            APP.activeChords.forEach(item => {
                                const noteIndex = current16th % item.chord.notes.length;
                                const note = item.chord.notes[noteIndex];
                                Audio.playOneShot(note.freq * freqMult, time, 0.15, item.modX, item.modY);
                                Vis.trigger(Theory.colors[item.index]);
                            });
                        }
                    }
                };
                loop();
            }
        };
    </script>
</body>
</html>

